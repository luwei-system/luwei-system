<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>시간의 흐름 — 루웨이</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./assets/Circle_logo.svg">
    <link rel="icon" type="image/png" href="./assets/favicon.png">
    <link rel="apple-touch-icon" href="./assets/favicon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@200;300;400;500&family=Cormorant+Garamond:wght@300;400;500&family=Playfair+Display:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- LUWEI Base CSS -->
    <link rel="stylesheet" href="./css/base.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', 'Cormorant Garamond', serif;
            background-image: url('./assets/모래시계속.png');
            background-size: 100% 100%;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            color: #111111;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 3s ease;
            position: relative;
            font-weight: 300;
        }
        
        /* Main Headline */
        .hourglass-headline {
            text-align: center;
            padding: 60px 20px 30px 20px;
            max-width: 800px;
            margin: 0 auto;
            z-index: 0; /* 버블을 가리지 않도록 낮춤 */
            position: relative;
            pointer-events: none; /* 클릭 방해 방지 */
        }
        
        .hourglass-title {
            font-family: 'Noto Sans KR', 'Cormorant Garamond', serif;
            font-size: 36px;
            font-weight: 300;
            color: rgba(255, 255, 255, 1);
            margin-bottom: 15px;
            letter-spacing: 3px;
            line-height: 1.6;
            text-shadow: 0 3px 30px rgba(0, 0, 0, 0.8), 0 1px 10px rgba(0, 0, 0, 0.6);
            white-space: normal;
            word-wrap: break-word;
            word-break: keep-all;
            overflow-wrap: break-word;
            padding: 0 20px;
        }
        
        .hourglass-subtitle {
            font-family: 'Noto Sans KR', 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.95);
            letter-spacing: 8px;
            text-transform: uppercase;
            font-style: italic;
            margin-bottom: 20px;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.7);
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 0 20px;
        }
        
        .hourglass-description {
            font-family: 'Noto Sans KR', 'Cormorant Garamond', serif;
            font-size: 16px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.8;
            letter-spacing: 1px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.7);
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            white-space: normal;
            word-wrap: break-word;
            word-break: keep-all;
            overflow-wrap: break-word;
        }
        
        body.loaded {
            opacity: 1;
        }
        
        /* Home Button */
        .home-button {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            z-index: 1000;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }
        
        .home-button:hover {
            transform: scale(1.05);
        }
        
        .home-button:active {
            transform: scale(0.95);
        }
        
        .back-button {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 60px;
            height: 60px;
            z-index: 1000;
            cursor: pointer;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .back-button:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .back-button:active {
            transform: scale(0.9);
        }
        
        /* Sand grains */
        .sand-grain {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-image: url('./assets/모래알.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 1;
            animation: float 8s ease-in-out infinite;
            box-shadow: 0 12px 48px rgba(255, 218, 185, 0.5);
            filter: brightness(1.1);
            z-index: 9000; /* sand-grain clickable above bubbles */
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .sand-grain:nth-child(1) {
            top: 20%;
            left: 15%;
            animation-delay: 0s;
        }
        
        .sand-grain:nth-child(2) {
            top: 40%;
            right: 20%;
            animation-delay: 2s;
        }
        
        .sand-grain:nth-child(3) {
            bottom: 25%;
            left: 30%;
            animation-delay: 4s;
        }
        
        .sand-grain:nth-child(4) {
            top: 60%;
            right: 15%;
            animation-delay: 1s;
        }
        
        .sand-grain:nth-child(5) {
            top: 10%;
            left: 50%;
            animation-delay: 3s;
        }
        
        .sand-grain:nth-child(6) {
            bottom: 15%;
            right: 40%;
            animation-delay: 5s;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            33% {
                transform: translateY(-30px) rotate(10deg);
            }
            66% {
                transform: translateY(-10px) rotate(-10deg);
            }
        }
        
        @keyframes floatAround {
            0% {
                top: 10%;
                left: 15%;
            }
            12.5% {
                top: 5%;
                left: 50%;
            }
            25% {
                top: 15%;
                left: 85%;
            }
            37.5% {
                top: 50%;
                left: 90%;
            }
            50% {
                top: 85%;
                left: 70%;
            }
            62.5% {
                top: 95%;
                left: 30%;
            }
            75% {
                top: 70%;
                left: 5%;
            }
            87.5% {
                top: 50%;
                left: 15%;
            }
            100% {
                top: 10%;
                left: 15%;
            }
        }
        
        /* Hourglass Music Toggle Button */
        .hourglass-music-toggle {
            position: fixed;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999 !important;
            transition: all 0.3s ease;
            animation: floatAround 60s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }
        
        .hourglass-music-toggle img {
            width: 35px;
            height: 35px;
            object-fit: contain;
            pointer-events: none;
        }
        
        .hourglass-music-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }
        
        .volume-control {
            position: fixed;
            bottom: 100px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            padding: 12px;
            z-index: 99999;
            display: none;
        }
        
        .volume-control.active {
            display: block;
        }
        
        .volume-control input[type="range"] {
            width: 120px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
        }
        
        .volume-control input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: none;
        }
        
        .volume-toggle {
            position: fixed;
            bottom: 20px;
            left: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .volume-toggle:hover {
            transform: scale(1.1);
        }
        
        .volume-toggle img {
            width: 30px;
            height: 30px;
        }
        
        /* Memory Modal */
        .memory-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000000;
        }
        
        .memory-modal.active {
            display: flex;
        }
        
        .memory-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .memory-modal-content h2 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #333;
            font-family: 'Noto Sans KR', 'Cormorant Garamond', serif;
        }
        
        .memory-modal-content textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-family: 'Noto Sans KR', 'Cormorant Garamond', serif;
            font-size: 16px;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .memory-modal-content textarea:focus {
            border-color: rgba(207, 232, 255, 0.8);
        }
        
        .memory-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .memory-modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-family: 'Noto Sans KR', 'Cormorant Garamond', serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .memory-modal-btn.save {
            background: rgba(207, 232, 255, 0.8);
            color: #333;
        }
        
        .memory-modal-btn.save:hover {
            background: rgba(207, 232, 255, 1);
            transform: scale(1.05);
        }
        
        .memory-modal-btn.cancel {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }
        
        .memory-modal-btn.cancel:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
        
        /* Color Picker */
        .memory-color-picker {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }
        
        .memory-color-label {
            font-size: 14px;
            color: #666;
            margin-right: 10px;
        }
        
        .color-picker-input {
            width: 60px;
            height: 40px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            cursor: pointer;
            outline: none;
            transition: all 0.3s;
        }
        
        .color-picker-input:hover {
            border-color: rgba(207, 232, 255, 0.8);
            transform: scale(1.1);
        }
        
        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            background: #CFE8FF;
        }
        
        /* Memory items */
        #memoryContainer {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        .memory-item {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            animation: float 8s ease-in-out infinite;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 2;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            padding: 0;
            text-align: center;
            word-wrap: break-word;
            overflow: hidden;
        }
        
        .memory-item:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.5);
        }
        .memory-item.pressed {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: transform 0.05s ease, box-shadow 0.05s ease;
        }
        
        .memory-item.expanded {
            width: 200px;
            height: 200px;
            border-radius: 20px;
            font-size: 12px;
            padding: 15px;
            z-index: 1000;
            animation: none !important;
        }
        
        .memory-item.expanded::before {
            content: '';
        }

        /* Needle tool */
        .needle-toggle {
            position: fixed;
            right: 12px;
            bottom: 100px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.029);
            border: 2px solid rgba(0,0,0,.08);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0,0,0,.15);
            z-index: 2147480000;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        .needle-toggle img {
            width: 72px;
            height: 72px;
            opacity: 1;
            object-fit: contain;
        }
        /* Needle ON visual */
        body.needle-on .needle-toggle {
            background: rgba(255, 255, 255, 0.92);
            box-shadow: 0 10px 28px rgba(0,0,0,.25);
            border-color: rgba(0,0,0,.12);
        }
        body.needle-on .needle-toggle img {
            opacity: 1;
        }
        
        body.needle-on {
            cursor: url('./assets/바늘.png') 8 8, pointer;
        }
        
        @media (max-width: 768px) {
            .home-button {
                width: 50px;
                height: 50px;
                top: 10px;
                right: 10px;
            }
            
            .back-button {
                width: 50px;
                height: 50px;
                top: 10px;
                left: 10px;
            }
            
            .back-button svg {
                width: 35px;
                height: 35px;
            }
            
            .sand-grain {
                width: 130px;
                height: 130px;
            }
            
            .footer {
                height: 50px;
            }
            
            .language-switcher {
                width: 45px;
                height: 35px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 768px) {
            .hourglass-headline {
                padding: 40px 15px 20px 15px;
            }
            
            .hourglass-title {
                font-size: 24px;
                letter-spacing: 1px;
            }
            
            .hourglass-subtitle {
                font-size: 14px;
                letter-spacing: 4px;
            }
            
            .hourglass-description {
                font-size: 13px;
                padding: 0 10px;
            }
        }
        
        @media (max-width: 480px) {
            .hourglass-headline {
                padding: 30px 10px 15px 10px;
            }
            
            .hourglass-title {
                font-size: 20px;
                letter-spacing: 0.5px;
            }
            
            .hourglass-subtitle {
                font-size: 12px;
                letter-spacing: 3px;
            }
            
            .hourglass-description {
                font-size: 12px;
                padding: 0 10px;
            }
            
            .home-button {
                width: 45px;
                height: 45px;
                top: 8px;
                right: 8px;
            }
            
            .back-button {
                width: 45px;
                height: 45px;
                top: 8px;
                left: 8px;
            }
            
            .back-button svg {
                width: 30px;
                height: 30px;
            }
            
            .sand-grain {
                width: 100px;
                height: 100px;
            }
            
            .footer {
                height: 45px;
            }
            
            .language-switcher {
                width: 40px;
                height: 30px;
                font-size: 11px;
            }
        }
        
        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: transparent;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Language Switcher */
        .language-switcher {
            cursor: pointer;
            width: 50px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 14px;
            color: white;
            font-weight: 500;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .language-switcher:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .language-switcher:active {
            transform: scale(0.95);
        }
        
        .lang-kr {
            display: block;
        }
        
        .lang-en {
            display: none;
        }
        
        body.lang-english .lang-kr {
            display: none;
        }
        
        body.lang-english .lang-en {
            display: block;
        }
        
        @keyframes rippleExpand {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(100);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Main Headline -->
    <div class="hourglass-headline">
        <h1 class="hourglass-title">
            <span class="lang-kr">모래시계에 담긴 당신의 이야기</span>
            <span class="lang-en">Your Story in the Hourglass</span>
        </h1>
        <p class="hourglass-subtitle">
            <span class="lang-kr">시간의 흐름</span>
            <span class="lang-en">The Flow of Time</span>
        </p>
        <p class="hourglass-description">
            <span class="lang-kr">앱에 적은 기억들이 이 공간에 흐릅니다. 당신의 시간, 당신의 중심에.</span>
            <span class="lang-en">Memories written in the app flow in this space. Your time, your center.</span>
        </p>
    </div>
    
    <!-- Home Button -->
    <div class="home-button" onclick="window.location.href='index.html'">
        <img src="./assets/home.jpg" alt="Home" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
    </div>
    
    <!-- Back Button -->
    <div class="back-button" onclick="window.location.href='luwei-room.html'">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M23 28L15 20L23 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>
    
    <!-- Sand grains floating -->
    <div class="sand-grain" onclick="openMemoryModal()" style="cursor: pointer;"></div>
    <div class="sand-grain" onclick="openMemoryModal()" style="cursor: pointer;"></div>
    <div class="sand-grain" onclick="openMemoryModal()" style="cursor: pointer;"></div>
    <div class="sand-grain" onclick="openMemoryModal()" style="cursor: pointer;"></div>
    <div class="sand-grain" onclick="openMemoryModal()" style="cursor: pointer;"></div>
    <div class="sand-grain" onclick="openMemoryModal()" style="cursor: pointer;"></div>
    
    <!-- Memory items container -->
    <div id="memoryContainer"></div>
    
    <!-- Background Music -->
    <audio id="hourglassMusic" loop autoplay>
        <source src="./assets/music/Hourglass Drift.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Music Toggle Button -->
    <div class="hourglass-music-toggle" id="musicToggleHourglass" onclick="toggleHourglassMusic()">
        <img src="./assets/음악아이콘.png" alt="Music" id="hourglassMusicIcon">
    </div>
    
    <!-- Volume Control -->
    <div class="volume-control" id="volumeControl">
        <label for="volumeSlider" style="font-size: 12px; color: #333;">볼륨:</label>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" oninput="updateVolume(this.value)">
    </div>
    
    <!-- Volume Toggle Button -->
    <div class="volume-toggle" id="volumeToggle" onclick="toggleVolumeControl()">
        <img src="./assets/음악아이콘.png" alt="Volume" style="width: 30px; height: 30px;">
    </div>

    <!-- Needle Toggle Button -->
    <div class="needle-toggle" id="needleToggle" title="바늘" onclick="toggleNeedle()">
        <img src="./assets/바늘.png" alt="needle" style="width:500px;height:100px;pointer-events:none;">
    </div>
    
    <!-- Memory Modal -->
    <div class="memory-modal" id="memoryModal">
        <div class="memory-modal-content">
            <h2><span class="lang-kr">당신의 기억을 남겨주세요</span><span class="lang-en">Leave Your Memory</span></h2>
            <textarea id="memoryText" placeholder="여기에 당신의 생각을 적어주세요..."></textarea>
            
            <!-- Color Picker -->
            <div class="memory-color-picker">
                <span class="memory-color-label"><span class="lang-kr">색상:</span><span class="lang-en">Color:</span></span>
                <input type="color" id="colorPicker" class="color-picker-input" value="#CFE8FF" onchange="updateColorPreview(this.value)">
                <div class="color-preview" id="colorPreview" style="background: #CFE8FF;"></div>
            </div>
            
            <!-- Room Display Checkbox -->
            <div class="memory-room-checkbox" style="margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #666;">
                    <input type="checkbox" id="roomDisplayCheck" style="width: 18px; height: 18px; cursor: pointer;">
                    <span><span class="lang-kr">방안에 넣기</span><span class="lang-en">Put in room</span></span>
                </label>
            </div>
            
            <div class="memory-modal-buttons">
                <button class="memory-modal-btn save" onclick="saveMemory()"><span class="lang-kr">저장</span><span class="lang-en">Save</span></button>
                <button class="memory-modal-btn cancel" onclick="closeMemoryModal()"><span class="lang-kr">취소</span><span class="lang-en">Cancel</span></button>
            </div>
        </div>
    </div>
    
    <script>
        window.addEventListener('load', function() {
            // Set initial opacity based on music state
            const button = document.getElementById('musicToggleHourglass');
            if (button) {
                button.style.opacity = '0.2'; // Music is playing initially
            }
            
            document.body.classList.add('loaded');

            // Ensure sand-grain is tappable on mobile
            try {
                document.querySelectorAll('.sand-grain').forEach(function(el){
                    el.addEventListener('touchstart', function(e){
                        e.preventDefault();
                        openMemoryModal();
                    }, { passive: false });
                });
            } catch(_) {}
        });
        
        function toggleLanguage() {
            document.body.classList.toggle('lang-english');
        }

        // Needle toggle (delete tool)
        window.__NEEDLE_ON = false;
        function toggleNeedle(){
            window.__NEEDLE_ON = !window.__NEEDLE_ON;
            document.body.classList.toggle('needle-on', window.__NEEDLE_ON);
        }
        
        // Hourglass music controls
        let isHourglassMusicPlaying = true;
        const hourglassMusic = document.getElementById('hourglassMusic');
        
        function toggleHourglassMusic() {
            // Get the button element
            const button = document.getElementById('musicToggleHourglass');
            
            // Add ripple effect
            const ripple = document.createElement('div');
            ripple.style.position = 'fixed';
            ripple.style.width = '20px';
            ripple.style.height = '20px';
            ripple.style.borderRadius = '50%';
            ripple.style.border = '2px solid rgba(222, 192, 162, 0.6)';
            ripple.style.pointerEvents = 'none';
            ripple.style.zIndex = '99999';
            ripple.style.left = window.innerWidth / 2 + 'px';
            ripple.style.top = window.innerHeight / 2 + 'px';
            ripple.style.transform = 'translate(-50%, -50%)';
            ripple.style.animation = 'rippleExpand 1s ease-out forwards';
            document.body.appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 1000);
            
            if (isHourglassMusicPlaying) {
                hourglassMusic.pause();
                isHourglassMusicPlaying = false;
                // Music paused - opacity 0.7 (70%)
                if (button) {
                    button.style.opacity = '0.7';
                }
            } else {
                hourglassMusic.play();
                isHourglassMusicPlaying = true;
                // Music playing - opacity 0.2 (20%)
                if (button) {
                    button.style.opacity = '0.2';
                }
            }
        }
        
        // Volume control
        function toggleVolumeControl() {
            const control = document.getElementById('volumeControl');
            if (control) {
                control.classList.toggle('active');
            }
        }
        
        function updateVolume(value) {
            if (hourglassMusic) {
                hourglassMusic.volume = value;
                localStorage.setItem('luwei_volume', value);
            }
        }
        
        // Load saved volume
        window.addEventListener('load', function() {
            const savedVolume = localStorage.getItem('luwei_volume');
            if (hourglassMusic && savedVolume !== null) {
                hourglassMusic.volume = parseFloat(savedVolume);
                const slider = document.getElementById('volumeSlider');
                if (slider) {
                    slider.value = savedVolume;
                }
            }
        });
        
        // Memory modal functions
        function openMemoryModal() {
            // Check if user is logged in
            const stored = localStorage.getItem('luwei_auth');
            if (!stored) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            const modal = document.getElementById('memoryModal');
            if (modal) {
                modal.classList.add('active');
            }
            
            // Set default color
            selectedColor = '#CFE8FF';
            const defaultColorOption = document.querySelector('.color-option[data-color="#CFE8FF"]');
            if (defaultColorOption) {
                defaultColorOption.classList.add('selected');
            }
        }
        
        function closeMemoryModal() {
            const modal = document.getElementById('memoryModal');
            const textarea = document.getElementById('memoryText');
            if (modal) {
                modal.classList.remove('active');
            }
            if (textarea) {
                textarea.value = '';
            }
            // Reset color picker
            const colorPicker = document.getElementById('colorPicker');
            const colorPreview = document.getElementById('colorPreview');
            if (colorPicker) {
                colorPicker.value = '#CFE8FF';
            }
            if (colorPreview) {
                colorPreview.style.background = '#CFE8FF';
            }
            selectedColor = '#CFE8FF'; // Reset to default
            
            // Reset room checkbox
            const roomCheck = document.getElementById('roomDisplayCheck');
            if (roomCheck) {
                roomCheck.checked = false;
            }
        }
        
        // Color selection
        let selectedColor = '#CFE8FF'; // Default color
        
        function updateColorPreview(color) {
            selectedColor = color;
            const colorPreview = document.getElementById('colorPreview');
            if (colorPreview) {
                colorPreview.style.background = color;
            }
        }
        
        async function saveMemory() {
            const textarea = document.getElementById('memoryText');
            const text = textarea ? textarea.value.trim() : '';
            
            if (!text) {
                alert('내용을 입력해주세요.');
                return;
            }
            
            try {
                // Check if user is logged in
                const stored = localStorage.getItem('luwei_auth');
                if (!stored) {
                    alert('로그인이 필요합니다.');
                    closeMemoryModal();
                    return;
                }
                
                const session = JSON.parse(stored);
                const userId = session.user && session.user.id;
                const accessToken = session.access_token;
                
                // Save to Supabase database
                const { createClient } = supabase;
                const supabaseClient = createClient(
                    window.__LUWEI_SUPABASE_CONFIG.url,
                    window.__LUWEI_SUPABASE_CONFIG.anonKey
                );
                
                // Get room display checkbox value
                const roomCheck = document.getElementById('roomDisplayCheck');
                const showInRoom = roomCheck ? roomCheck.checked : false;
                
                // Use supabase client with auth
                // Store color in content_url field temporarily
                const { data, error } = await supabaseClient
                    .from('artifact')
                    .insert({
                        user_id: userId,
                        kind: 'text',
                        text_content: text,
                        content_url: selectedColor, // Store selected color
                        is_public: showInRoom, // Show in room if checked
                        created_at: new Date().toISOString()
                    })
                    .select('*');
                
                if (error) {
                    throw error;
                }
                
                // Also save to localStorage for backup
                const memories = JSON.parse(localStorage.getItem('hourglass_memories') || '[]');
                memories.push({
                    id: Date.now(),
                    text: text,
                    color: selectedColor,
                    userId: userId,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('hourglass_memories', JSON.stringify(memories));
                
                alert('기억이 저장되었습니다.');
                closeMemoryModal();
                
                // Reload memories to show the new one
                loadMemories();
                
                // Notify other pages (room) to refresh
                try {
                    localStorage.setItem('luwei_room_ping', String(Date.now()));
                } catch(_) {}
                try {
                    const bc = new BroadcastChannel('luwei-memories');
                    bc.postMessage({ type: 'new_memory', public: showInRoom });
                    // No need to close; browser will GC
                } catch(_) {}
                
            } catch (err) {
                console.error('Error saving memory:', err);
                alert('저장 중 오류가 발생했습니다: ' + err.message);
            }
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('memoryModal');
            if (modal && e.target === modal) {
                closeMemoryModal();
            }
        });
        
        // Load and display memories (requires auth)
        async function loadMemories() {
            try {
                const container = document.getElementById('memoryContainer');
                if (!container) return;
                
                // Require auth: hide when logged out
                let authed = false;
                try { authed = !!JSON.parse(localStorage.getItem('luwei_auth')||'null'); } catch(_) {}
                if (!authed) {
                    container.innerHTML = '';
                    container.style.display = 'none';
                    return;
                } else {
                    container.style.display = 'block';
                }
                container.innerHTML = '';
                
                // Load from Supabase
                const { createClient } = supabase;
                const supabaseClient = createClient(
                    window.__LUWEI_SUPABASE_CONFIG.url,
                    window.__LUWEI_SUPABASE_CONFIG.anonKey
                );
                
                const { data, error } = await supabaseClient
                    .from('artifact')
                    .select('*')
                    .eq('kind', 'text')
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) {
                    console.error('Error loading memories:', error);
                    return;
                }
                
                // Display memories for hourglass: show ALL (public + private)
                (data || []).forEach((memory, index) => {
                    const memoryEl = document.createElement('div');
                    memoryEl.className = 'memory-item';
                    
                    const color = memory.content_url || '#CFE8FF';
                    const text = memory.text_content || '';
                    
                    memoryEl.style.background = color;
                    memoryEl.style.left = (5 + Math.random()*90) + '%';
                    memoryEl.style.top = (10 + Math.random()*70) + '%';
                    memoryEl.style.animationDelay = (index * 0.5) + 's';
                    memoryEl.textContent = text;
                    memoryEl.setAttribute('data-text', text);
                    if (memory.id) memoryEl.dataset.id = memory.id;
                    
                    // Make draggable (mouse/touch)
                    makeDraggable(memoryEl);

                    // Click to expand (needle 모드 여부와 무관하게 항상 열기/닫기)
                    memoryEl.onclick = function(e) {
                        e.stopPropagation();
                        const isExpanded = this.classList.contains('expanded');
                        
                        // Close other expanded items
                        document.querySelectorAll('.memory-item.expanded').forEach(item => {
                            if (item !== this) {
                                item.classList.remove('expanded');
                                item.style.fontSize = '0';
                                item.style.padding = '0';
                            }
                        });
                        
                        if (isExpanded) {
                            this.classList.remove('expanded');
                            this.style.fontSize = '0';
                            this.style.padding = '0';
                        } else {
                            this.classList.add('expanded');
                            // show full text and improve contrast
                            this.classList.remove('pressed');
                            const full = this.getAttribute('data-text') || '(내용 없음)';
                            this.textContent = full;
                            this.style.fontSize = '14px';
                            this.style.padding = '16px';
                            const bg = this.style.background || '#CFE8FF';
                            this.style.color = isDarkColor(bg) ? '#fff' : '#111';
                            this.style.opacity = '1';
                        }
                    };
                    
                    container.appendChild(memoryEl);
                });
                
            } catch (err) {
                console.error('Error loading memories:', err);
            }
        }
        
        // Draggable helper for bubbles
        function makeDraggable(el){
            let dragging = false;
            let startX = 0, startY = 0;
            let origLeft = 0, origTop = 0;
            const container = document.getElementById('memoryContainer');
            const getPoint = (e)=>{
                if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                return { x: e.clientX, y: e.clientY };
            };
            const pointerDown = (e)=>{
                // ignore when expanded (needle mode에서도 드래그 가능)
                if (el.classList.contains('expanded')) return;
                dragging = true;
                const p = getPoint(e);
                startX = p.x; startY = p.y;
                // normalize to px for stable dragging
                origLeft = el.offsetLeft;
                origTop = el.offsetTop;
                el.style.left = origLeft + 'px';
                el.style.top = origTop + 'px';
                el.classList.add('pressed');
                // Show text immediately on press
                if (!el.classList.contains('expanded')) {
                    el.classList.add('expanded');
                    const full = el.getAttribute('data-text') || '(내용 없음)';
                    el.textContent = full;
                    el.style.fontSize = '14px';
                    el.style.padding = '16px';
                    const bg = el.style.background || '#CFE8FF';
                    el.style.color = isDarkColor(bg) ? '#fff' : '#111';
                    el.style.opacity = '1';
                }
                e.preventDefault();
            };
            const pointerMove = (e)=>{
                if (!dragging) return;
                const p = getPoint(e);
                const dx = p.x - startX;
                const dy = p.y - startY;
                let nx = origLeft + dx;
                let ny = origTop + dy;
                // keep inside viewport
                const maxX = (container ? container.clientWidth : window.innerWidth) - el.offsetWidth;
                const maxY = (container ? container.clientHeight : window.innerHeight) - el.offsetHeight;
                nx = Math.max(0, Math.min(maxX, nx));
                ny = Math.max(0, Math.min(maxY, ny));
                el.style.left = nx + 'px';
                el.style.top = ny + 'px';
                e.preventDefault();
            };
            const pointerUp = async ()=>{
                if (dragging) {
                    // When released, if overlapping needle tool and needle is ON, delete
                    try {
                        const needle = document.getElementById('needleToggle');
                        if (needle && window.__NEEDLE_ON) {
                            const nr = needle.getBoundingClientRect();
                            const br = el.getBoundingClientRect();
                            const overlap = !(br.right < nr.left || br.left > nr.right || br.bottom < nr.top || br.top > nr.bottom);
                            if (overlap) {
                                const id = el.dataset.id;
                                if (id) {
                                    const { createClient } = supabase;
                                    const supabaseClient = createClient(
                                        window.__LUWEI_SUPABASE_CONFIG.url,
                                        window.__LUWEI_SUPABASE_CONFIG.anonKey
                                    );
                                    const { error: delErr } = await supabaseClient
                                        .from('artifact')
                                        .delete()
                                        .eq('id', id);
                                    if (delErr) throw delErr;
                                }
                                el.remove();
                                try { localStorage.setItem('luwei_room_ping', String(Date.now())); } catch(_) {}
                                try { const bc = new BroadcastChannel('luwei-memories'); bc.postMessage({type:'new_memory', public:true}); } catch(_) {}
                            }
                        }
                    } catch(_) {}
                }
                el.classList.remove('pressed');
                dragging = false;
            };
            el.addEventListener('mousedown', pointerDown);
            window.addEventListener('mousemove', pointerMove, { passive:false });
            window.addEventListener('mouseup', pointerUp);
            el.addEventListener('touchstart', pointerDown, { passive:false });
            window.addEventListener('touchmove', pointerMove, { passive:false });
            window.addEventListener('touchend', pointerUp, { passive:true });
        }

        // Color contrast helper
        function hexToRgb(hex){
            if (!hex) return {r:255,g:255,b:255};
            const m = hex.replace('#','');
            const v = m.length===3 ? m.split('').map(c=>c+c).join('') : m;
            const num = parseInt(v,16);
            return { r:(num>>16)&255, g:(num>>8)&255, b:num&255 };
        }
        function isDarkColor(hex){
            const {r,g,b} = hexToRgb(hex);
            // perceived luminance
            const L = 0.299*r + 0.587*g + 0.114*b;
            return L < 140; // threshold
        }
        
        // Load memories on page load and on visibility change
        window.addEventListener('load', function() {
            loadMemories();
        });
        document.addEventListener('visibilitychange', function(){
            if (!document.hidden) loadMemories();
        });
    </script>
    
    <!-- Footer with Language Switcher -->
    <footer class="footer">
        <div class="language-switcher" onclick="toggleLanguage()">
            <span class="lang-kr">한</span>
            <span class="lang-en">EN</span>
        </div>
    </footer>
    
    <!-- LUWEI Phase 0 Scripts (Player not used) -->
    <script src="./js/hourglass.js"></script>
    <script src="./js/luwei-supabase.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <script src="./js/luwei-auth.js?v=3"></script>
    <script>
        window.__LUWEI_SUPABASE_CONFIG = {
            url: 'https://ngyjzclndgffwzhoukuj.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5neWp6Y2xuZGdmZnd6aG91a3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2Mzc3MDksImV4cCI6MjA3NzIxMzcwOX0.z2HvEUaVjiJ2HhfC8Qxf1Ka0Acpc3DtW4IM8dLYV_o0',
            functionsUrl: 'https://ngyjzclndgffwzhoukuj.supabase.co/functions/v1'
        };
        if (window.luweiSupabase) {
            window.luweiSupabase.setConfig(window.__LUWEI_SUPABASE_CONFIG);
        }
    </script>
</body>
</html>

